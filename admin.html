<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard ‚Äî Borodina.Pilates</title>
    
    <!-- –°—Ç–∏–ª–∏ –∞–¥–º–∏–Ω–∫–∏ -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É Grid.js –¥–ª—è –∫—Ä–∞—Å–∏–≤—ã—Ö —Ç–∞–±–ª–∏—Ü -->
    <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>

    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: 'JetBrains Mono', monospace; padding: 20px; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; } /* –ß—É—Ç—å —à–∏—Ä–µ –¥–ª—è —Ç–∞–±–ª–∏—Ü */
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #30363d; padding-bottom: 20px; }
        h1 { font-size: 1.5rem; margin: 0; color: #58a6ff; }
        .status-badge { background: #238636; color: #fff; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        
        .card { background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 20px; overflow: hidden; }
        .card h2 { font-size: 1rem; margin-top: 0; color: #8b949e; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; }
        
        .big-number { font-size: 2.5rem; font-weight: bold; color: #f0f6fc; margin: 10px 0; }
        .sub-text { font-size: 0.85rem; color: #8b949e; }
        .money { color: #3fb950; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è Grid.js –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ (–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ) */
        .gridjs-container { color: #c9d1d9; font-family: 'JetBrains Mono', monospace; }
        .gridjs-wrapper { border: 1px solid #30363d; border-radius: 6px; }
        .gridjs-table { width: 100%; }
        th.gridjs-th { background-color: #21262d; color: #8b949e; border-bottom: 1px solid #30363d; border-top: none; }
        td.gridjs-td { background-color: #0d1117; border-bottom: 1px solid #30363d; }
        .gridjs-footer { background-color: #161b22; border-top: 1px solid #30363d; }
        .gridjs-search-input { background-color: #0d1117; border: 1px solid #30363d; color: #fff; }
        
        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .action-btn { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 5px; font-weight: bold; }
        .btn-ban { background: #da3633; color: white; }
        .btn-unban { background: #238636; color: white; }
        .btn-ban:hover { background: #b62324; }
        
        .btn-refresh { background: #1f6feb; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 20px;}
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>SYSTEM_CONTROL</h1>
        <div class="status-badge" id="system-status">CONNECTING...</div>
    </header>

    <!-- –í–µ—Ä—Ö–Ω–∏–µ —Ü–∏—Ñ—Ä—ã -->
    <div class="grid">
        <div class="card">
            <h2>üí∞ Finance (MRR)</h2>
            <div class="big-number money" id="mrr-val">-</div>
            <div class="sub-text">–ü—Ä–æ–≥–Ω–æ–∑ –≤—ã—Ä—É—á–∫–∏ (–ê–∫—Ç–∏–≤–Ω—ã–µ KZT)</div>
            <div style="margin-top: 10px;">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤: <span id="active-val" style="color:#fff">-</span></div>
        </div>
        <div class="card">
            <h2>üõ° Security</h2>
            <div class="big-number" style="color: #f85149;" id="banned-val">-</div>
            <div class="sub-text">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞—Ä—É—à–∏—Ç–µ–ª–µ–π</div>
        </div>
        <div class="card">
            <h2>üåê Traffic Today</h2>
            <div class="big-number" id="traffic-today">-</div>
            <div class="sub-text">–í–∏–∑–∏—Ç–æ–≤ –Ω–∞ —Å–∞–π—Ç –∑–∞ 24—á</div>
        </div>
    </div>

    <!-- –¢–ê–ë–õ–ò–¶–ê 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
    <div class="card" style="margin-bottom: 20px;">
        <h2>üë• –ë–∞–∑–∞ –ö–ª–∏–µ–Ω—Ç–æ–≤ (–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)</h2>
        <div id="users-grid"></div>
    </div>

    <!-- –¢–ê–ë–õ–ò–¶–ê 2: –í—ã—Ä—É—á–∫–∞ -->
    <div class="card">
        <h2>üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–ª–∞—Ç—ã</h2>
        <div id="revenue-grid"></div>
    </div>

    <button class="btn-refresh" onclick="location.reload()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
</div>

<script>
    const API_URL = 'https://n8n.borodin.live/webhook/admin-stats';
    const ACTION_URL = 'https://n8n.borodin.live/webhook/admin-action';

    async function loadData() {
        try {
            const res = await fetch(API_URL);
            const data = await res.json();

            // 1. –ó–∞–ø–æ–ª–Ω—è–µ–º —Ü–∏—Ñ—Ä—ã
            document.getElementById('mrr-val').innerText = new Intl.NumberFormat('ru-RU').format(data.finance.mrr) + ' ‚Ç∏';
            document.getElementById('active-val').innerText = data.finance.active_total;
            document.getElementById('banned-val').innerText = data.security.banned;
            document.getElementById('traffic-today').innerText = data.traffic.today;

            // 2. –†–µ–Ω–¥–µ—Ä–∏–º –¢–∞–±–ª–∏—Ü—É –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            const users = data.users_table || [];
            
            new gridjs.Grid({
                columns: [
                    "Sub ID",  // <--- –ù–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞
                    "User ID",
                    "–ò–º—è", 
                    "–£—Ä–æ–≤–µ–Ω—å", 
                    "–°—Ç–∞—Ç—É—Å", 
                    "–ò—Å—Ç–µ–∫–∞–µ—Ç", 
                    { 
                        name: "–î–µ–π—Å—Ç–≤–∏—è",
                        formatter: (cell, row) => {
                            // –í–ê–ñ–ù–û: –ò–Ω–¥–µ–∫—Å—ã —Å–¥–≤–∏–Ω—É–ª–∏—Å—å –∏–∑-–∑–∞ –Ω–æ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏!
                            // row.cells[0].data = Sub ID
                            // row.cells[1].data = User ID
                            // row.cells[4].data = –°—Ç–∞—Ç—É—Å (banned/active)
                            
                            const subId = row.cells[0].data;
                            const userId = row.cells[1].data;
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–±–∞–Ω–µ–Ω –ª–∏ —é–∑–µ—Ä (–¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞–µ–º –≤ 6-–π —Å—Ç–æ–ª–±–µ—Ü –Ω–∏–∂–µ)
                            const isBanned = row.cells[4].data === true || row.cells[4].data === 'true' || row.cells[4].data === 'banned'; 
                            
                            // –ü–µ—Ä–µ–¥–∞–µ–º —Ç–µ–ø–µ—Ä—å –¢–†–ò –ø–∞—Ä–∞–º–µ—Ç—Ä–∞: userId, subId, action
                            if (isBanned) {
                                return gridjs.html(`<button class="action-btn btn-unban" onclick="userAction('${userId}', '${subId}', 'unban')">UNBAN</button>`);
                            } else {
                                return gridjs.html(`<button class="action-btn btn-ban" onclick="userAction('${userId}', '${subId}', 'ban')">BAN</button>`);
                            }
                        }
                    }
                ],
                data: users.map(u => [
                    u.subscription_id, // <--- 0. Sub ID
                    u.user_id,         // <--- 1. User ID
                    u.first_name + (u.username ? ` (@${u.username})` : ''),
                    u.level,
                    u.banned ? true : u.status, // <--- 4. –°—Ç–∞—Ç—É—Å –¥–ª—è –ª–æ–≥–∏–∫–∏
                    u.expires_date,
                    null 
                ]),
                search: true,
                pagination: { limit: 10 },
                sort: true,
                language: { search: { placeholder: '–ü–æ–∏—Å–∫...' } }
            }).render(document.getElementById("users-grid"));

            // 3. –†–µ–Ω–¥–µ—Ä–∏–º –¢–∞–±–ª–∏—Ü—É –û–ø–ª–∞—Ç
            const payments = data.revenue_table || [];
            
            new gridjs.Grid({
                columns: ["–î–∞—Ç–∞", "–°—É–º–º–∞", "–í–∞–ª—é—Ç–∞", "ID –ó–∞–∫–∞–∑–∞", "–°—Ç–∞—Ç—É—Å"],
                data: payments.map(p => [
                    p.date,
                    p.amount,
                    p.currency,
                    p.order_id,
                    p.status
                ]),
                pagination: { limit: 5 },
                sort: true
            }).render(document.getElementById("revenue-grid"));

            // –°—Ç–∞—Ç—É—Å
            document.getElementById('system-status').innerText = 'ONLINE';
            document.getElementById('system-status').style.background = '#238636';

        } catch (e) {
            console.error(e);
            document.getElementById('system-status').innerText = 'ERROR';
            document.getElementById('system-status').style.background = '#f85149';
            alert('–û—à–∏–±–∫–∞: ' + e.message);
        }
    }

    // --- –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ö–ù–û–ü–û–ö ---
    // –î–æ–±–∞–≤–∏–ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç subId
    window.userAction = async (userId, subId, action) => {
        const confirmText = action === 'ban' ? 
            `‚õîÔ∏è –í–ù–ò–ú–ê–ù–ò–ï!\n–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ –ó–ê–ë–ê–ù–ò–¢–¨ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId} (Sub #${subId})?` : 
            `‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}?`;

        if(!confirm(confirmText)) return;

        try {
            const res = await fetch(ACTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–ø–µ—Ä—å –∏ subscription_id
                body: JSON.stringify({ user_id: userId, subscription_id: subId, action: action })
            });
            
            if (res.ok) {
                alert('–£—Å–ø–µ—à–Ω–æ! –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è.');
                location.reload(); 
            } else {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.');
            }
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
        }
    };
    
    // –ó–∞–ø—É—Å–∫
    loadData();
</script>

</body>
</html>